# Build iOS IPA on push to main and upload to GitHub Releases.
# The latest IPA is always at:
#   https://github.com/Jrtowers-prog/PlymHack2026New/releases/download/latest/SafeNightHome.ipa
#
# Required secrets (Settings → Secrets → Actions):
#   IOS_CERTIFICATE_P12        — Base64-encoded .p12 distribution certificate
#   IOS_CERTIFICATE_PASSWORD   — Password for the .p12
#   IOS_PROVISIONING_PROFILE   — Base64-encoded .mobileprovision (Ad Hoc)
#   APPLE_TEAM_ID              — Your 10-character Apple Developer Team ID
#   EXPO_PUBLIC_API_BASE_URL   — Backend gateway URL
#   EXPO_PUBLIC_SAFETY_API_URL — Backend safety service URL
#   EXPO_PUBLIC_OSM_USER_AGENT — OSM user agent string
#   EXPO_PUBLIC_OSM_EMAIL      — OSM contact email

name: Build iOS IPA

on:
  # push:
  #   branches: [main]
  workflow_dispatch: # manual trigger only until Apple signing secrets are added

jobs:
  build:
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install JS dependencies
        run: npm ci

      - name: Create .env for build
        run: |
          cat <<EOF > .env
          EXPO_PUBLIC_API_BASE_URL=${{ secrets.EXPO_PUBLIC_API_BASE_URL }}
          EXPO_PUBLIC_SAFETY_API_URL=${{ secrets.EXPO_PUBLIC_SAFETY_API_URL }}
          EXPO_PUBLIC_OSM_USER_AGENT=${{ secrets.EXPO_PUBLIC_OSM_USER_AGENT }}
          EXPO_PUBLIC_OSM_EMAIL=${{ secrets.EXPO_PUBLIC_OSM_EMAIL }}
          EXPO_PUBLIC_BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      - name: Generate native iOS project
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install

      - name: Install Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.IOS_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # Decode certificate and profile
          echo "$P12_BASE64" | base64 --decode > certificate.p12
          echo "$PROFILE_BASE64" | base64 --decode > profile.mobileprovision

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain

          # Import certificate
          security import certificate.p12 -k build.keychain \
            -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

          # Clean up decoded files
          rm certificate.p12 profile.mobileprovision

      - name: Build and archive
        working-directory: ios
        run: |
          xcodebuild archive \
            -workspace SafeNightHome.xcworkspace \
            -scheme SafeNightHome \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/SafeNightHome.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_STYLE=Manual \
            | tail -30

      - name: Export IPA
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/SafeNightHome.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist ExportOptions.plist

          mv "$RUNNER_TEMP/export/SafeNightHome.ipa" SafeNightHome.ipa

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build (${{ steps.sha.outputs.short }})"
          body: |
            Automatically built from commit `${{ github.sha }}`.

            **Download:**
            - [SafeNightHome.apk](https://github.com/Jrtowers-prog/PlymHack2026New/releases/download/latest/SafeNightHome.apk) (Android)
            - [SafeNightHome.ipa](https://github.com/Jrtowers-prog/PlymHack2026New/releases/download/latest/SafeNightHome.ipa) (iOS)
          files: SafeNightHome.ipa
          prerelease: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up keychain
        if: always()
        run: security delete-keychain build.keychain || true
